# ğŸ“˜ 5G NR SIB1 ASN.1 TCP Encoder/Decoder

A complete TCP-based demonstration of building, encoding, transmitting, receiving, and decoding a 5G NR System Information Block Type 1 (SIB1) message using ASN.1 PER encoding.

---

## ğŸš€ Overview

This project demonstrates end-to-end 5G NR SIB1 message handling over TCP:

- **Build** a BCCH-DL-SCH-Message containing SIB1
- **Encode** using PER (Packed Encoding Rules)
- **Transmit** over TCP socket from client to server
- **Receive** and **decode** on remote system
- **Display** all SIB1 fields in human-readable format

**Perfect for:**
- 5G NR RRC protocol implementation (3GPP TS 38.331)
- Learning ASN.1 encoding/decoding
- Testing TCP-based message transport
- Network protocol development and research

---

## ğŸ“‹ Prerequisites

- **OS:** Linux (Ubuntu 20.04+ recommended)
- **Compiler:** GCC 7.5+
- **Tools:** asn1c, make, git
- **Network:** TCP/IP stack (localhost or remote)

---

## ğŸ”§ Installation

### Install Dependencies
```bash
sudo apt-get update
sudo apt-get install -y build-essential git autoconf libtool
```

### Install ASN1C Compiler

**Quick Install:**
```bash
sudo apt-get install -y asn1c
```

**Or build from source (latest):**
```bash
git clone https://github.com/vlm/asn1c.git
cd asn1c
autoreconf -iv
./configure
make
sudo make install
cd ..
```

Verify:
```bash
asn1c -version
```

---

## ğŸ—ï¸ Project Structure
```
nr-sib1-asn1-tcp-demo/
â”‚
â”œâ”€â”€ asn1/
â”‚   â””â”€â”€ NR-RRC-Definitions.asn    # 3GPP TS 38.331 ASN.1 definitions
â”‚
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ encoder.c                  # TCP client: builds & sends SIB1
â”‚   â””â”€â”€ decoder.c                  # TCP server: receives & decodes SIB1
â”‚
â”œâ”€â”€ generated/                     # Auto-generated by asn1c
â”‚   â”œâ”€â”€ *.c                        # ASN.1 C implementation
â”‚   â””â”€â”€ *.h                        # ASN.1 C headers
â”‚
â”œâ”€â”€ Makefile                       # Build automation
â”œâ”€â”€ LICENSE                        # MIT License
â””â”€â”€ README.md                      # This file
```

---

## ğŸ› ï¸ Setup

### 1. Clone Repository
```bash
git clone https://github.com/yourusername/nr-sib1-asn1-tcp-demo.git
cd nr-sib1-asn1-tcp-demo
```

### 2. Get ASN.1 Definitions

Download 3GPP TS 38.331 ASN.1 files and place in `asn1/` folder.

### 3. Generate ASN.1 C Code
```bash
asn1c -fcompound-names -findirect-choice -fno-include-deps -gen-PER -pdu=BCCH-DL-SCH-Message asn1/*.asn
```

**Flags:**
- `-fcompound-names` - Use compound type names
- `-findirect-choice` - Indirect pointers for CHOICE
- `-fno-include-deps` - Skip dependency files
- `-gen-PER` - Enable PER encoding/decoding
- `-pdu=BCCH-DL-SCH-Message` - Specify top-level PDU

### 4. Organize Files
```bash
mkdir -p generated
mv *.c *.h generated/
```

### 5. Build
```bash
make clean
make
```

**Output:**
- `encoder` - TCP client (sends SIB1)
- `decoder` - TCP server (receives SIB1)

---

## â–¶ï¸ Running the Demo

### Terminal 1: Start TCP Server (Decoder)
```bash
./decoder
```

**Output:**
```
[TCP SERVER] Initializing...
[TCP SERVER] Binding to port 8888...
[TCP SERVER] Listening for connections...
[TCP SERVER] Waiting for client...
```

### Terminal 2: Run TCP Client (Encoder)
```bash
./encoder
```

**Output:**
```
[TCP CLIENT] Building SIB1 message...
[TCP CLIENT] Setting PLMN: MCC=001, MNC=01
[TCP CLIENT] Setting TAC: 0x000001
[TCP CLIENT] Setting Cell Identity: 123456789
[TCP CLIENT] SIB1 structure complete
[TCP CLIENT] PER encoding...
[TCP CLIENT] Encoded successfully: 47 bytes
[TCP CLIENT] Connecting to 127.0.0.1:8888...
[TCP CLIENT] TCP connection established
[TCP CLIENT] Sending 47 bytes...
[TCP CLIENT] Data transmitted successfully
[TCP CLIENT] Closing connection
```

### Server Output (After Client Connects)
```
[TCP SERVER] Client connected: 127.0.0.1:54321
[TCP SERVER] Receiving data...
[TCP SERVER] Received: 47 bytes
[TCP SERVER] PER decoding...
[TCP SERVER] Decode successful!

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘         DECODED SIB1 CONTENT           â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“¡ PLMN Identity:
   MCC: 001
   MNC: 01

ğŸ—ºï¸  Tracking Area Code (TAC): 
   Hex: 0x000001
   Dec: 1

ğŸ“¶ Cell Identity:
   Value: 123456789 (0x075BCD15)
   Bits: 28

ğŸš« Cell Barred: notBarred
ğŸ”„ Intra-Frequency Reselection: allowed

ğŸ“Š Signal Thresholds:
   Q-RxLevMin: -70 dBm
   Q-QualMin: -20 dB

ğŸ“» Frequency Band: 78 (n78 - 3.5 GHz)
â° System Frame Number: 512

[TCP SERVER] Connection closed
[TCP SERVER] Waiting for next client...
```

---

## ğŸŒ TCP Configuration

### Change Server IP/Port

**In encoder.c (client):**
```c
#define SERVER_IP "127.0.0.1"      // Change for remote server
#define SERVER_PORT 8888            // Match server port
```

**In decoder.c (server):**
```c
#define LISTEN_PORT 8888            // Server listening port
#define LISTEN_ADDR "0.0.0.0"       // Bind to all interfaces
```

### Remote Server Setup

**On Server Machine:**
```bash
./decoder
```

**On Client Machine:**
```bash
# Edit encoder.c to set SERVER_IP = "192.168.1.100"
make
./encoder
```

### Firewall Rules

Allow TCP traffic:
```bash
sudo ufw allow 8888/tcp
sudo ufw status
```

---

## ğŸ” TCP Architecture
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     ENCODER (TCP CLIENT)          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. Build SIB1 Structure          â”‚
â”‚ 2. Populate Fields               â”‚
â”‚ 3. PER Encode â†’ Binary           â”‚
â”‚ 4. socket()                      â”‚
â”‚ 5. connect(SERVER_IP:8888)       â”‚â”€â”€TCPâ”€â”€â”
â”‚ 6. send(encoded_data, 47)        â”‚       â”‚
â”‚ 7. close()                       â”‚       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
                                            â”‚
                                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     DECODER (TCP SERVER)          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. socket()                      â”‚
â”‚ 2. bind(0.0.0.0:8888)            â”‚
â”‚ 3. listen()                      â”‚
â”‚ 4. accept() â† Client             â”‚
â”‚ 5. recv(buffer, 1024)            â”‚
â”‚ 6. PER Decode â†’ Structure        â”‚
â”‚ 7. Extract & Print Fields        â”‚
â”‚ 8. close()                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š SIB1 Message Fields

| Field | Type | Value | Description |
|-------|------|-------|-------------|
| **MCC** | 3 digits | 001 | Mobile Country Code |
| **MNC** | 2-3 digits | 01 | Mobile Network Code |
| **TAC** | 24 bits | 0x000001 | Tracking Area Code |
| **Cell ID** | 36 bits | 123456789 | Cell Identity |
| **Cell Barred** | ENUM | notBarred | Access status |
| **Intra Resel** | ENUM | allowed | Reselection allowed |
| **Q-RxLevMin** | INTEGER | -70 dBm | Min RX level |
| **Q-QualMin** | INTEGER | -20 dB | Min quality |
| **Freq Band** | INTEGER | 78 | NR band (n78) |
| **SFN** | INTEGER | 512 | System Frame Number |

---

## ğŸ§ª Testing & Debugging

### TCP Connection Test

**Check if server is listening:**
```bash
netstat -tuln | grep 8888
```

**Test with telnet:**
```bash
telnet 127.0.0.1 8888
```

**Monitor TCP traffic:**
```bash
sudo tcpdump -i lo -A 'tcp port 8888'
```

### Enable Debug Output

**In encoder.c:**
```c
asn_debug = 1;  // Enable ASN.1 debug
```

**In decoder.c:**
```c
asn_debug = 1;  // Verbose decoding
```

### Print Hex Dump

Add to encoder.c:
```c
void print_hex(const uint8_t *data, size_t len) {
    printf("Encoded bytes (%zu):\n", len);
    for (size_t i = 0; i < len; i++) {
        printf("%02X ", data[i]);
        if ((i + 1) % 16 == 0) printf("\n");
    }
    printf("\n");
}
```

### XER (XML) Output

View SIB1 as XML:
```c
xer_fprint(stdout, &asn_DEF_BCCH_DL_SCH_Message, bcch_msg);
```

### Wireshark Capture

Capture TCP packets:
```bash
sudo tcpdump -i lo -w sib1.pcap 'tcp port 8888'
wireshark sib1.pcap
```

---

## ğŸ› Troubleshooting

### Connection Refused
**Problem:** Client cannot connect to server

**Solutions:**
```bash
# Verify server is running
ps aux | grep decoder

# Check port availability
netstat -tuln | grep 8888

# Disable firewall temporarily
sudo ufw disable

# Check IP address
ifconfig
```

### Bind Address Already in Use
**Problem:** Port 8888 already in use

**Solutions:**
```bash
# Find process using port
sudo lsof -i :8888

# Kill process
sudo kill -9 <PID>

# Or use different port in both encoder.c and decoder.c
```

### Decoding Fails
**Problem:** PER decode returns error

**Solutions:**
- Ensure same ASN.1 files used for both encoder/decoder
- Check encoded data length matches what was sent
- Enable `asn_debug = 1` to see detailed errors
- Verify PER encoding options are identical

### Partial Data Received
**Problem:** recv() gets incomplete message

**Solution - Add length prefix:**
```c
// Encoder: send length first
uint32_t len = htonl(encoded_size);
send(sock, &len, sizeof(len), 0);
send(sock, buffer, encoded_size, 0);

// Decoder: read length first
uint32_t len;
recv(sock, &len, sizeof(len), MSG_WAITALL);
len = ntohl(len);
recv(sock, buffer, len, MSG_WAITALL);
```

---

## ğŸ”’ TCP Security (Future)

### Add TLS/SSL
```bash
# Install OpenSSL
sudo apt-get install libssl-dev

# Modify code to use SSL_connect() and SSL_accept()
```

### Authentication
```c
// Simple token-based auth
#define AUTH_TOKEN "secret123"

// Client sends token first
send(sock, AUTH_TOKEN, strlen(AUTH_TOKEN), 0);

// Server validates
char token[64];
recv(sock, token, sizeof(token), 0);
if (strcmp(token, AUTH_TOKEN) != 0) {
    close(client_sock);
}
```

---

## ğŸ“š References

- **3GPP TS 38.331** - NR RRC Protocol
  - [Specification](https://www.3gpp.org/DynaReport/38331.htm)
- **ITU-T X.691** - PER Encoding Rules
  - [Standard](https://www.itu.int/rec/T-REC-X.691)
- **asn1c** - ASN.1 Compiler
  - [GitHub](https://github.com/vlm/asn1c)
- **TCP/IP Sockets** - Network Programming
  - [Beej's Guide](https://beej.us/guide/bgnet/)

---

## ğŸš€ Next Steps

### Phase 1: Enhanced TCP
- [ ] Add message length prefix
- [ ] Implement timeout handling
- [ ] Support multiple concurrent clients
- [ ] Add reconnection logic

### Phase 2: More SIBs
- [ ] Add SIB2 (radio resource config)
- [ ] Add SIB3 (cell reselection)
- [ ] Add SIB4 (intra-freq neighbors)
- [ ] SystemInformation message

### Phase 3: Production Features
- [ ] TLS encryption
- [ ] Message authentication
- [ ] Rate limiting
- [ ] Logging and monitoring

---
